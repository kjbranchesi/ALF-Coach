rules_version = '2';

// Firebase Storage Security Rules for ALF Coach
// CRITICAL: User isolation and access control for project showcases
// Last updated: January 2025

service firebase.storage {
  match /b/{bucket}/o {

    // Helper functions for authentication and validation
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isAnonymous() {
      return isAuthenticated() && request.auth.token.firebase.sign_in_provider == 'anonymous';
    }

    // Validate file size limits
    function isWithinSizeLimit(maxSizeMB) {
      return request.resource.size <= maxSizeMB * 1024 * 1024;
    }

    // Validate content type
    function isValidContentType() {
      return request.resource.contentType.matches('application/json') ||
             request.resource.contentType.matches('application/octet-stream');
    }

    // USER PROJECT SHOWCASES
    // Path: users/{userId}/projects/{projectId}/showcase.json
    // Size limit: 10MB per showcase (large JSON with runOfShow, assignments, outcomes)
    match /users/{userId}/projects/{projectId}/{allFiles=**} {
      // Read: Owner or anonymous users (for URL sharing)
      allow read: if
        isOwner(userId) ||
        (isAnonymous() && userId == 'anonymous');

      // Write: Only the owner can create/update/delete their own showcases
      allow write: if
        isOwner(userId) &&
        isWithinSizeLimit(10) &&
        isValidContentType();
    }

    // ANONYMOUS USER SHOWCASES
    // Path: anonymous/projects/{projectId}/showcase.json
    // Allows temporary URL-shareable projects for unauthenticated users
    match /anonymous/projects/{projectId}/{allFiles=**} {
      // Anyone can read anonymous showcases (for sharing)
      allow read: if true;

      // Anonymous users can write to their own projects
      // Rate limiting enforced at application level
      allow write: if
        isAnonymous() &&
        isWithinSizeLimit(10) &&
        isValidContentType();
    }

    // USER PROFILE ASSETS (future feature)
    // Path: users/{userId}/profile/{fileName}
    match /users/{userId}/profile/{fileName} {
      allow read: if true; // Public profile images
      allow write: if
        isOwner(userId) &&
        isWithinSizeLimit(5) &&
        request.resource.contentType.matches('image/.*');
    }

    // SHARED RESOURCES (future feature)
    // Path: shared/{shareId}/{fileName}
    match /shared/{shareId}/{allFiles=**} {
      allow read: if isAuthenticated();
      allow write: if false; // Only via Cloud Functions
    }

    // PUBLIC TEMPLATES (read-only)
    // Path: templates/{templateId}/{fileName}
    match /templates/{templateId}/{allFiles=**} {
      allow read: if true;
      allow write: if false; // Admin only via Firebase Admin SDK
    }

    // DEFAULT DENY
    // Deny all access to any paths not explicitly matched above
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
